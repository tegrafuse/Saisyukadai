{% extends "base.html" %}
{% import "_sidebar.html" as sidebar %}

{% block content %}
  <div style="display:flex;height:calc(100vh - 70px)">
    {{ sidebar.community_sidebar(communities, followed_communities, official_communities) }}
    <div style="flex:1;overflow-y:auto;padding:20px">
      <div style="max-width:1200px;margin:0 auto">
        <div class="card p-4">
          <div class="d-flex align-items-center gap-3">
            {% if user.avatar_filename %}
              <img src="{{ url_for('main.uploaded_file', filename=user.avatar_filename|build_upload_path('avatars')) }}" class="rounded-circle" style="width:108px;height:108px;object-fit:cover">
            {% else %}
              <div class="logo" style="width:108px;height:108px;border-radius:50%"></div>
            {% endif %}
            <div style="flex:1">
              <div class="d-flex justify-content-between align-items-start mb-2">
                <div>
                  <h2 class="h5">{{ user.display_name or user.username }} <span class="text-muted" style="font-size:0.9em">@{{ user.username }}</span></h2>
                  {% if bio %}
                    <div class="text-muted mt-1" style="font-size:0.95em">{{ bio }}</div>
                  {% endif %}
                </div>
                <div>
                  {% if g.user and g.user.id == user.id %}
                    <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#editProfileModal">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†</button>
                  {% elif g.user and g.user.username != user.username %}
                    <a href="{{ url_for('main.messages', username=user.username) }}" class="btn btn-sm btn-outline-primary">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡</a>
                  {% endif %}
                </div>
              </div>
              <!-- Follow stats -->
              <div class="d-flex gap-4 mt-3">
                <div style="cursor:pointer;" data-bs-toggle="modal" data-bs-target="#followModal">
                  <strong>{{ user_followed_communities|length }}</strong>
                  <span class="text-muted">ãƒ•ã‚©ãƒ­ãƒ¼</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Followed Communities Modal -->
        <div class="modal fade" id="followModal" tabindex="-1" aria-labelledby="followModalLabel" aria-hidden="true">
          <div class="modal-dialog modal-lg">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="followModalLabel">{{ user.display_name or user.username }}ã•ã‚“ãŒãƒ•ã‚©ãƒ­ãƒ¼ä¸­ã®ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                {% if user_followed_communities %}
                  <div class="row g-3">
                    {% for c in user_followed_communities %}
                      <div class="col-md-6">
                        <a href="{{ url_for('main.community_page', community_id=c.id) }}" class="text-decoration-none">
                          <div class="card p-3 h-100 border-0" style="transition: box-shadow 0.2s ease, transform 0.2s ease; box-shadow: 0 2px 8px rgba(0,0,0,0.08); cursor:pointer;" 
                               onmouseover="this.style.boxShadow='0 6px 16px rgba(0,0,0,0.12)'; this.style.transform='translateY(-2px)'" 
                               onmouseout="this.style.boxShadow='0 2px 8px rgba(0,0,0,0.08)'; this.style.transform=''">
                            <div class="d-flex align-items-center gap-3">
                              {% if c.icon_filename %}
                                <img src="{{ url_for('main.uploaded_file', filename=c.icon_filename|build_upload_path('community_icons')) }}" alt="{{ c.name }}" class="rounded" style="width:56px;height:56px;object-fit:cover;flex-shrink:0">
                              {% else %}
                                <div class="logo" style="width:56px;height:56px;flex-shrink:0;border-radius:8px"></div>
                              {% endif %}
                              <div class="flex-grow-1" style="min-width:0">
                                <div class="fw-semibold text-dark">{{ c.name }}</div>
                                <div class="text-muted small">{{ c.follows|length }}äººãŒãƒ•ã‚©ãƒ­ãƒ¼ãƒ»{{ c.posts|length }}ä»¶ã®ã‚¹ãƒ¬ãƒƒãƒ‰</div>
                              </div>
                            </div>
                          </div>
                        </a>
                      </div>
                    {% endfor %}
                  </div>
                {% else %}
                  <p class="text-muted text-center">ãƒ•ã‚©ãƒ­ãƒ¼ä¸­ã®ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã¯ã‚ã‚Šã¾ã›ã‚“</p>
                {% endif %}
              </div>
            </div>
          </div>
        </div>

  <!-- Edit Profile Modal -->
  <div class="modal fade" id="editProfileModal" tabindex="-1" aria-labelledby="editProfileModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <form action="{{ url_for('main.settings') }}" method="post" enctype="multipart/form-data">
          <input type="hidden" name="next" value="{{ request.path }}">
          <div class="modal-header">
            <h5 class="modal-title" id="editProfileModalLabel">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="mb-2"><input name="display_name" class="input" placeholder="è¡¨ç¤ºå" value="{{ g.user.display_name or '' }}"></div>
            <div class="mb-2"><label class="form-label">è‡ªå·±ç´¹ä»‹</label><textarea name="bio" class="input" rows="3">{{ bio or '' }}</textarea></div>
            <div class="mb-2">
              <label class="form-label">ã‚¢ãƒã‚¿ãƒ¼</label>
              <input id="user-edit-avatar-input" class="avatar-input form-control" data-preview-target="user-edit-avatar-preview" type="file" name="avatar" accept="image/*">
              <div id="user-edit-avatar-preview" style="display:none;margin-top:8px">
                <img id="user-edit-avatar-img" src="#" class="rounded" style="width:64px;height:64px;object-fit:cover">
                <button type="button" id="user-edit-avatar-remove" class="btn btn-sm secondary">å‰Šé™¤</button>
              </div>
            </div>
            {% if g.user.avatar_filename %}
              <div class="mt-2" id="current-avatar-block-modal">
                <img id="current-avatar-img-modal" src="{{ url_for('main.uploaded_file', filename=g.user.avatar_filename|build_upload_path('avatars')) }}" class="rounded" style="width:64px;height:64px;object-fit:cover">
                <input type="hidden" name="remove_avatar" id="remove_avatar_input_modal" value="">
                <div class="mt-2">
                  <button type="button" id="remove_avatar_modal_button" class="btn btn-sm btn-outline-danger">ã‚¢ãƒã‚¿ãƒ¼ã‚’å‰Šé™¤</button>
                </div>
              </div>
            {% endif %}
          </div>
          <div class="modal-footer">
            <button type="submit" class="btn btn-primary">ä¿å­˜</button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Sort Options -->
  {% if posts %}
  <div class="d-flex align-items-center justify-content-between mb-3 mt-4">
    <h3 class="mb-0">æŠ•ç¨¿</h3>
    <select class="form-select form-select-sm" style="width:auto" onchange="window.location.href=this.value">
      <option value="{{ url_for('main.user', username=user.username, sort='latest') }}" {% if sort_by == 'latest' or not sort_by %}selected{% endif %}>æœ€æ–°é †</option>
      <option value="{{ url_for('main.user', username=user.username, sort='likes') }}" {% if sort_by == 'likes' %}selected{% endif %}>ã„ã„ã­æ•°é †</option>
      <option value="{{ url_for('main.user', username=user.username, sort='replies') }}" {% if sort_by == 'replies' %}selected{% endif %}>è¿”ä¿¡æ•°é †</option>
    </select>
  </div>
  {% else %}
  <h3 class="mt-4">æŠ•ç¨¿</h3>
  {% endif %}
  <div class="list">
    {% for p in posts %}
      <div class="card post-card mb-3" style="cursor:default;">
        <div class="d-flex gap-3 align-items-start">
          {% if user.avatar_filename %}
            {% if g.user and g.user.id == user.id %}
              <form action="{{ url_for('main.settings') }}" method="post" enctype="multipart/form-data" class="d-inline">
                <input type="hidden" name="next" value="{{ request.path }}">
                <input type="file" name="avatar" id="avatar-input-user-{{ user.id }}" class="d-none" onchange="this.form.submit()">
                <label for="avatar-input-user-{{ user.id }}" style="cursor:pointer; display:inline-block;">
                  <img src="{{ url_for('main.uploaded_file', filename=user.avatar_filename|build_upload_path('avatars')) }}" class="rounded-circle" style="width:48px;height:48px;object-fit:cover">
                </label>
              </form>
            {% else %}
              <a href="{{ url_for('main.user', username=user.username) }}" class="text-decoration-none">
                <img src="{{ url_for('main.uploaded_file', filename=user.avatar_filename|build_upload_path('avatars')) }}" class="rounded-circle" style="width:48px;height:48px;object-fit:cover">
              </a>
            {% endif %}
          {% else %}
            <a href="{{ url_for('main.user', username=user.username) }}" class="text-decoration-none">
              <div class="logo" style="width:48px;height:48px"></div>
            </a>
          {% endif %}
          <div style="flex:1">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <div class="post-meta d-flex align-items-center gap-1 mb-1">
                  {% if p.community and p.community.icon_filename %}
                    <img src="{{ url_for('main.uploaded_file', filename=p.community.icon_filename|build_upload_path('community_icons')) }}" alt="icon" style="width:18px;height:18px;object-fit:cover;border-radius:4px;">
                  {% endif %}
                  <span class="fw-semibold">{{ p.community.name if p.community else 'æœªæ‰€å±' }}</span>
                </div>
                <div class="post-title mb-1">{{ user.display_name or user.username }} <span class="text-muted" style="font-size:0.9em">@{{ user.username }}</span></div>
                <div class="text-muted small">{{ p.created_at|time_ago }}</div>
              </div>
              <div>
                {% if g.user and g.user.id == p.user_id %}
                  <form action="{{ url_for('main.delete_post', post_id=p.id) }}" method="post" style="display:inline" onsubmit="return confirm('æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ');">
                    <input type="hidden" name="next" value="{{ request.path }}">
                    <button type="submit" class="btn btn-sm btn-danger">å‰Šé™¤</button>
                  </form>
                {% endif %}
              </div>
            </div>
            <div class="mt-2">{{ p.body }}</div>
            {% if p.images %}
              {% set first_img = (p.images | sort(attribute='order'))[0] %}
              {% set img_count = p.images | length %}
              <div class="mt-3 position-relative d-inline-block">
                <img src="{{ url_for('main.uploaded_file', filename=first_img.filename|build_upload_path('posts')) }}" alt="post image" class="rounded post-image-thumbnail" style="max-width:100%;max-height:320px;object-fit:contain;cursor:pointer;display:block" data-post-id="{{ p.id }}" data-image-filename="{{ first_img.filename }}" data-image-order="{{ first_img.order }}">
                {% if img_count > 1 %}
                  <span class="badge bg-dark position-absolute bottom-0 end-0 m-2" style="font-size:0.9rem">+{{ img_count - 1 }}æš</span>
                {% endif %}
              </div>
            {% endif %}
            {% if p.video_filename %}
              <div class="mt-3">
                <video controls style="width:100%;max-height:400px;border-radius:8px">
                  <source src="{{ url_for('main.uploaded_file', filename=p.video_filename|build_upload_path('posts')) }}">
                  ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯å‹•ç”»å†ç”Ÿã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚
                </video>
              </div>
            {% endif %}
            <div class="mt-3 d-flex align-items-center gap-2 flex-wrap justify-content-between">
              <div class="d-flex align-items-center gap-3 flex-wrap">
                {% if g.user %}
                  {% set is_liked = p.id in g.liked_post_ids %}
                  {% set like_count = p.likes|length if p.likes else 0 %}
                  <a href="#" class="like-btn d-inline-flex align-items-center gap-1 {% if is_liked %}text-danger{% else %}text-muted{% endif %}"
                     data-post-id="{{ p.id }}"
                     data-liked="{{ 'true' if is_liked else 'false' }}"
                     style="text-decoration:none;cursor:pointer;">
                    <span>{{ 'â¤ï¸' if is_liked else 'ğŸ¤' }}</span>
                    <span>ã„ã„ã­</span>
                    {% if like_count > 0 %}<span class="like-count">{{ like_count }}</span>{% endif %}
                  </a>
                {% endif %}
                <a class="d-inline-flex align-items-center gap-1 text-muted" href="{{ url_for('main.view_post', post_id=p.id, open_reply=1) }}" style="text-decoration:none;">
                  <span>ğŸ’¬</span><span>è¿”ä¿¡</span><span>({{ p.replies|length }})</span>
                </a>
              </div>
              <a class="btn btn-sm btn-link text-decoration-none" href="{{ url_for('main.view_post', post_id=p.id) }}">â†— ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’é–‹ã</a>
            </div>
          </div>
        </div>
      </div>
    {% else %}
      <div class="card p-3">ã¾ã æŠ•ç¨¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>
    {% endfor %}
      </div>
    </div>
  </div>
{% endblock %}