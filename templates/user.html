{% extends "base.html" %}

{% block content %}
  <div class="card p-4">
    <div class="d-flex align-items-center gap-3">
      {% if user.avatar_filename %}
        <img src="{{ url_for('main.uploaded_file', filename=user.avatar_filename) }}" class="rounded-circle" style="width:72px;height:72px;object-fit:cover">
      {% else %}
        <div class="logo" style="width:72px;height:72px;border-radius:50%"></div>
      {% endif %}
      <div style="flex:1" class="d-flex justify-content-between align-items-start">
        <div>
          <h2 class="h5">{{ user.display_name or user.username }}</h2>
          {% if bio %}
            <div class="text-muted mt-2">{{ bio }}</div>
          {% endif %}
        </div>
        <div>
          {% if g.user and g.user.id == user.id %}
            <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#editProfileModal">Edit profile</button>
          {% elif g.user and g.user.username != user.username %}
            <a href="{{ url_for('main.messages', username=user.username) }}" class="btn btn-sm btn-outline-primary">Message</a>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Profile Modal -->
  <div class="modal fade" id="editProfileModal" tabindex="-1" aria-labelledby="editProfileModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <form action="{{ url_for('main.settings') }}" method="post" enctype="multipart/form-data">
          <input type="hidden" name="next" value="{{ request.path }}">
          <div class="modal-header">
            <h5 class="modal-title" id="editProfileModalLabel">Edit profile</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="mb-2"><input name="display_name" class="input" placeholder="表示名" value="{{ g.user.display_name or '' }}"></div>
            <div class="mb-2"><label class="form-label">自己紹介</label><textarea name="bio" class="input" rows="3">{{ bio or '' }}</textarea></div>
            <div class="mb-2">
              <label class="form-label">Avatar</label>
              <input id="user-edit-avatar-input" class="avatar-input form-control" data-preview-target="user-edit-avatar-preview" type="file" name="avatar" accept="image/*">
              <div id="user-edit-avatar-preview" style="display:none;margin-top:8px">
                <img id="user-edit-avatar-img" src="#" class="rounded" style="width:64px;height:64px;object-fit:cover">
                <button type="button" id="user-edit-avatar-remove" class="btn btn-sm secondary">削除</button>
              </div>
            </div>
            {% if g.user.avatar_filename %}
              <div class="mt-2" id="current-avatar-block-modal">
                <img id="current-avatar-img-modal" src="{{ url_for('main.uploaded_file', filename=g.user.avatar_filename) }}" class="rounded" style="width:64px;height:64px;object-fit:cover">
                <input type="hidden" name="remove_avatar" id="remove_avatar_input_modal" value="">
                <div class="mt-2">
                  <button type="button" id="remove_avatar_modal_button" class="btn btn-sm btn-outline-danger">Delete avatar</button>
                </div>
              </div>
            {% endif %}
          </div>
          <div class="modal-footer">
            <button type="submit" class="btn btn-primary">Save</button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <h3 class="mt-4">Posts</h3>
  <div class="list">
    {% for p in posts %}
      <div class="card post-card mb-3">
        <div class="d-flex gap-3">
          {% if user.avatar_filename %}
            {% if g.user and g.user.id == user.id %}
              <form action="{{ url_for('main.settings') }}" method="post" enctype="multipart/form-data" class="d-inline">
                <input type="hidden" name="next" value="{{ request.path }}">
                <input type="file" name="avatar" id="avatar-input-user-{{ user.id }}" class="d-none" onchange="this.form.submit()">
                <label for="avatar-input-user-{{ user.id }}" style="cursor:pointer; display:inline-block;">
                  <img src="{{ url_for('main.uploaded_file', filename=user.avatar_filename) }}" class="rounded-circle" style="width:48px;height:48px;object-fit:cover">
                </label>
              </form>
            {% else %}
              <img src="{{ url_for('main.uploaded_file', filename=user.avatar_filename) }}" class="rounded-circle" style="width:48px;height:48px;object-fit:cover">
            {% endif %}
          {% else %}
            <div class="logo" style="width:48px;height:48px"></div>
          {% endif %}
          <div style="flex:1">
            <div class="d-flex justify-content-between">
              <div>
                <div class="post-title">{{ user.display_name or user.username }}</div>
                <div class="post-meta">{{ p.created_at }}</div>
              </div>
              <div>
                {% if g.user and g.user.id == p.user_id %}
                  <form action="{{ url_for('main.delete_post', post_id=p.id) }}" method="post" style="display:inline" onsubmit="return confirm('本当に削除しますか？');">
                    <input type="hidden" name="next" value="{{ request.path }}">
                    <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                  </form>
                {% endif %}
              </div>
            </div>
            <div class="mt-2">{{ p.body }}</div>
            {% if p.image_filename %}
              <div class="mt-3">
                <img src="{{ url_for('main.uploaded_file', filename=p.image_filename) }}" class="img-fluid rounded" />
              </div>
            {% endif %}
          </div>
        </div>
      </div>
    {% else %}
      <div class="card p-3">No posts yet.</div>
    {% endfor %}
  </div>
{% endblock %}