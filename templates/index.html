{% extends "base.html" %}

{% block content %}
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h1 class="h3">Feed</h1>
  </div>

  {% if g.user %}
  <div class="card form-card mb-4">
    <form action="{{ url_for('main.create_post') }}" method="post" enctype="multipart/form-data">
      <div class="d-flex gap-3">
        {% if g.user and g.user.avatar_filename %}
          <img src="{{ url_for('main.uploaded_file', filename=g.user.avatar_filename) }}" class="rounded-circle" style="width:48px;height:48px;object-fit:cover" alt="avatar">
        {% else %}
          <div class="logo" aria-hidden="true"></div>
        {% endif %}
        <div style="flex:1">
          <div class="mb-2">
            <textarea name="body" rows="3" class="input" placeholder="いまどうしてる？（本文または画像を投稿できます）"></textarea>
          </div>
          <div class="d-flex gap-2 align-items-center">
            <input id="post-image-input" type="file" name="image" accept="image/*" class="form-control form-control-sm" style="max-width:200px">
            <button type="submit" class="btn">投稿</button>
          </div>
          <div id="post-image-preview" class="mt-2" style="display:none">
            <p class="post-meta">画像プレビュー</p>
            <img id="post-preview-img" src="#" class="img-fluid rounded" style="max-height:240px" />
            <div><button type="button" id="post-remove-image" class="btn btn-sm secondary mt-2">画像を削除</button></div>
          </div>
        </div>
      </div>
    </form>
  </div>
  {% else %}
    <p class="card p-3">ログインして投稿できます。</p>
  {% endif %}

  <h2 class="mt-4">Posts</h2>
  <div class="list">
    {% for p in posts %}
      <div class="card post-card mb-3">
        <div class="d-flex align-items-start gap-3">
          {% if p.author.avatar_filename %}
                {% if g.user and g.user.id == p.author.id %}
                  <form action="{{ url_for('main.settings') }}" method="post" enctype="multipart/form-data" class="d-inline">
                    <input type="hidden" name="next" value="{{ request.path }}">
                    <input type="file" name="avatar" id="avatar-input-{{ p.id }}" class="d-none" onchange="this.form.submit()">
                    <label for="avatar-input-{{ p.id }}" style="cursor:pointer; display:inline-block;">
                      <img src="{{ url_for('main.uploaded_file', filename=p.author.avatar_filename) }}" alt="avatar" class="rounded-circle" style="width:48px;height:48px;object-fit:cover">
                    </label>
                  </form>
                {% else %}
                  <img src="{{ url_for('main.uploaded_file', filename=p.author.avatar_filename) }}" alt="avatar" class="rounded-circle" style="width:48px;height:48px;object-fit:cover">
                {% endif %}
                {% else %}
                <div class="logo" aria-hidden="true" style="width:48px;height:48px"></div>
                {% endif %}
          <div style="flex:1">
            <div class="d-flex justify-content-between">
              <div>
                <div class="post-title"><a href="{{ url_for('main.user', username=p.author.username) }}" class="text-decoration-none text-dark">{{ p.author.display_name or p.author.username }}</a></div>
                <div class="post-meta">{{ p.created_at }}</div>
              </div>
              <div>
                {% if g.user and g.user.id == p.user_id %}
                  <form action="{{ url_for('main.delete_post', post_id=p.id) }}" method="post" style="display:inline" onsubmit="return confirm('本当に削除しますか？');">
                    <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                  </form>
                {% endif %}
              </div>
            </div>
            <div class="mt-2">{{ p.body }}</div>
            {% if p.image_filename %}
              <div class="mt-3">
                <a href="{{ url_for('main.uploaded_file', filename=p.image_filename) }}">
                  <img src="{{ url_for('main.uploaded_file', filename=p.image_filename) }}" alt="{{ p.image_caption }}" class="img-fluid rounded">
                </a>
                {% if p.image_caption %}
                  <div class="mt-2 text-muted">{{ p.image_caption }}</div>
                {% endif %}
              </div>
            {% endif %}
          </div>
        </div>
      </div>
    {% else %}
      <div class="card p-3">No posts yet.</div>
    {% endfor %}
  </div> 


{% endblock %}
