{% extends 'base.html' %}
{% import "_sidebar.html" as sidebar %}

{% block content %}
  <div style="display:flex;height:calc(100vh - 70px)">
    {{ sidebar.community_sidebar(communities, followed_communities, official_communities) }}

    <div style="flex:1;overflow-y:auto;padding:20px">
      <div style="max-width:1200px;margin:0 auto">
        <!-- Community header -->
        <div class="card p-4 mb-4">
          <div class="row align-items-start">
            <div class="col-auto">
              {% if community.icon_filename %}
                <img src="{{ url_for('main.uploaded_file', filename=community.icon_filename) }}" alt="{{ community.name }}" class="rounded" style="width:100px;height:100px;object-fit:cover">
              {% else %}
                <div class="logo" aria-hidden="true" style="width:100px;height:100px"></div>
              {% endif %}
            </div>
            <div class="col">
              <h1 class="h3 mb-2">{{ community.name }}</h1>
              <div class="d-flex gap-4 mb-3">
                <div>
                  <strong>{{ followers_count }}</strong>
                  <span class="text-muted">ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼</span>
                </div>
                <div>
                  <strong>{{ posts_count }}</strong>
                  <span class="text-muted">ã‚¹ãƒ¬ãƒƒãƒ‰</span>
                </div>
                <div>
                  <strong>{{ community.created_at.strftime('%Yå¹´%mæœˆ%dæ—¥') }}</strong>
                  <span class="text-muted">è¨­ç«‹æ—¥</span>
                </div>
              </div>
              {% if g.user %}
                {% set is_following = community.id in g.following_ids %}
                <div>
                  <form action="{{ url_for('main.unfollow_community' if is_following else 'main.follow_community', community_id=community.id) }}" method="post" style="display:inline">
                    <input type="hidden" name="next" value="{{ request.full_path }}">
                    <button type="submit" class="btn {% if is_following %}btn-outline-secondary{% else %}btn-primary{% endif %}" {% if community.created_by == g.user.id %}disabled{% endif %}>
                      {% if community.created_by == g.user.id %}
                        è¨­ç«‹è€…
                      {% else %}
                        {{ 'ãƒ•ã‚©ãƒ­ãƒ¼è§£é™¤' if is_following else 'ãƒ•ã‚©ãƒ­ãƒ¼ã™ã‚‹' }}
                      {% endif %}
                    </button>
                  </form>
                  {% if community.created_by == g.user.id %}
                    <form action="{{ url_for('main.delete_community', community_id=community.id) }}" method="post" style="display:inline" onsubmit="return confirm('ã“ã®ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿé–¢é€£ã™ã‚‹ã‚¹ãƒ¬ãƒƒãƒ‰ã‚‚å‰Šé™¤ã•ã‚Œã¾ã™ã€‚');">
                      <button type="submit" class="btn btn-outline-danger">å‰Šé™¤</button>
                    </form>
                  {% endif %}
                </div>
              {% else %}
                <div>
                  <a href="{{ url_for('main.login') }}" class="btn btn-primary">ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãƒ•ã‚©ãƒ­ãƒ¼</a>
                </div>
              {% endif %}
            </div>

            <!-- Creator info (right side, small) -->
            {% if creator %}
              <div class="col-auto" style="flex-basis:200px;flex-shrink:0">
                <div class="border-start ps-3">
                  <h6 class="mb-2" style="font-size:0.85rem">è¨­ç«‹è€…</h6>
                  <div class="d-flex align-items-center gap-2">
                    {% if creator.avatar_filename %}
                      <a href="{{ url_for('main.user', username=creator.username) }}" class="text-decoration-none flex-shrink-0">
                        <img src="{{ url_for('main.uploaded_file', filename=creator.avatar_filename) }}" alt="avatar" class="rounded-circle" style="width:36px;height:36px;object-fit:cover">
                      </a>
                    {% else %}
                      <a href="{{ url_for('main.user', username=creator.username) }}" class="text-decoration-none flex-shrink-0">
                        <div class="logo" aria-hidden="true" style="width:36px;height:36px;border-radius:50%"></div>
                      </a>
                    {% endif %}
                    <div class="flex-grow-1" style="min-width:0">
                      <a href="{{ url_for('main.user', username=creator.username) }}" class="text-decoration-none text-dark d-block" style="font-size:0.85rem;font-weight:600">
                        {{ creator.display_name or creator.username }}
                      </a>
                      <p class="text-muted mb-0" style="font-size:0.75rem">@{{ creator.username }}</p>
                    </div>
                  </div>
                </div>
              </div>
            {% else %}
              <div class="col-auto" style="flex-basis:200px;flex-shrink:0">
                <div class="border-start ps-3">
                  <h6 class="mb-2" style="font-size:0.85rem">è¨­ç«‹è€…</h6>
                  <div class="d-flex align-items-center gap-2">
                    <div class="logo" aria-hidden="true" style="width:36px;height:36px;border-radius:50%"></div>
                    <div class="flex-grow-1" style="min-width:0">
                      <div class="d-block" style="font-size:0.85rem;font-weight:600">Official</div>
                      <p class="text-muted mb-0" style="font-size:0.75rem">@official</p>
                    </div>
                  </div>
                </div>
              </div>
            {% endif %}
          </div>

          <!-- Description -->
          {% if community.description %}
            <div class="mt-3 pt-3 border-top">
              <p class="text-muted mb-0">{{ community.description }}</p>
            </div>
          {% endif %}
        </div>

        <!-- Posts list -->
        <div class="d-flex align-items-center justify-content-between mb-3">
          <div>
            {% if g.user and (community.id in g.following_ids) %}
              <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createPostModal">
                + ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’ä½œæˆ
              </button>
            {% else %}
              <h3 class="h5 mb-0">ã‚¹ãƒ¬ãƒƒãƒ‰ä¸€è¦§</h3>
            {% endif %}
          </div>
          <div>
            {% if posts %}
              <select class="form-select form-select-sm" style="width:auto" onchange="window.location.href=this.value">
                <option value="{{ url_for('main.community_page', community_id=community.id, sort='latest') }}" {% if sort_by == 'latest' or not sort_by %}selected{% endif %}>æœ€æ–°é †</option>
                <option value="{{ url_for('main.community_page', community_id=community.id, sort='likes') }}" {% if sort_by == 'likes' %}selected{% endif %}>ã„ã„ã­æ•°é †</option>
                <option value="{{ url_for('main.community_page', community_id=community.id, sort='replies') }}" {% if sort_by == 'replies' %}selected{% endif %}>è¿”ä¿¡æ•°é †</option>
              </select>
            {% endif %}
          </div>
        </div>
        {% if posts %}
          {% for post in posts %}
            <div class="card post-card mb-3" style="cursor:default;">
              <div class="d-flex align-items-start gap-3">
                {% if post.author.avatar_filename %}
                  <a href="{{ url_for('main.user', username=post.author.username) }}" class="text-decoration-none">
                    <img src="{{ url_for('main.uploaded_file', filename=post.author.avatar_filename) }}" alt="avatar" class="rounded-circle" style="width:48px;height:48px;object-fit:cover">
                  </a>
                {% else %}
                  <a href="{{ url_for('main.user', username=post.author.username) }}" class="text-decoration-none">
                    <div class="logo" aria-hidden="true" style="width:48px;height:48px"></div>
                  </a>
                {% endif %}
                <div class="flex-grow-1" style="min-width:0">
                  <div class="d-flex justify-content-between align-items-start">
                    <div>
                      <div class="post-meta d-flex align-items-center gap-1 mb-1">
                        {% if post.community and post.community.icon_filename %}
                          <img src="{{ url_for('main.uploaded_file', filename=post.community.icon_filename) }}" alt="icon" style="width:18px;height:18px;object-fit:cover;border-radius:4px;">
                        {% endif %}
                        <span class="fw-semibold">{{ post.community.name if post.community else 'æœªæ‰€å±' }}</span>
                      </div>
                      <div class="post-title mb-1"><a href="{{ url_for('main.user', username=post.author.username) }}" class="text-decoration-none text-dark">{{ post.author.display_name or post.author.username }}</a> <span class="text-muted" style="font-size:0.9em">@{{ post.author.username }}</span></div>
                      <div class="text-muted small">{{ post.created_at|time_ago }}</div>
                    </div>
                    <div class="text-end">
                      <div class="small text-muted">{{ post.replies|length }} ä»¶ã®è¿”ä¿¡</div>
                      {% if g.user and g.user.id == post.user_id %}
                        <form action="{{ url_for('main.delete_post', post_id=post.id) }}" method="post" style="display:inline" onsubmit="return confirm('æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ');">
                          <button type="submit" class="btn btn-sm btn-danger">å‰Šé™¤</button>
                        </form>
                      {% endif %}
                    </div>
                  </div>
                  <p class="mb-2" style="overflow:hidden;text-overflow:ellipsis;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical">{{ post.body }}</p>
                  {% if post.images %}
                    {% set first_img = (post.images | sort(attribute='order'))[0] %}
                    {% set img_count = post.images | length %}
                    <div class="mt-3 position-relative d-inline-block">
                      <img src="{{ url_for('main.uploaded_file', filename=first_img.filename) }}" alt="post image" class="rounded post-image-thumbnail" style="max-width:100%;max-height:320px;object-fit:contain;cursor:pointer;display:block" data-post-id="{{ post.id }}" data-image-filename="{{ first_img.filename }}" data-image-order="{{ first_img.order }}">
                      {% if img_count > 1 %}
                        <span class="badge bg-dark position-absolute bottom-0 end-0 m-2" style="font-size:0.9rem">+{{ img_count - 1 }}æš</span>
                      {% endif %}
                    </div>
                  {% endif %}
                  {% if post.video_filename %}
                    <div class="mt-3">
                      <video controls style="width:100%;max-height:400px;border-radius:8px">
                        <source src="{{ url_for('main.uploaded_file', filename=post.video_filename) }}">
                        ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯å‹•ç”»å†ç”Ÿã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚
                      </source>
                      </video>
                    </div>
                  {% endif %}
                  <div class="d-flex align-items-center gap-2 flex-wrap mt-2 justify-content-between">
                    <div class="d-flex align-items-center gap-3 flex-wrap">
                      {% if g.user %}
                        {% set is_liked = post.id in g.liked_post_ids %}
                        {% set like_count = post.likes|length if post.likes else 0 %}
                        <a href="#" class="like-btn d-inline-flex align-items-center gap-1 {% if is_liked %}text-danger{% else %}text-muted{% endif %}"
                           data-post-id="{{ post.id }}"
                           data-liked="{{ 'true' if is_liked else 'false' }}"
                           style="text-decoration:none;cursor:pointer;">
                          <span>{{ 'â¤ï¸' if is_liked else 'ğŸ¤' }}</span>
                          <span>ã„ã„ã­</span>
                          {% if like_count > 0 %}<span class="like-count">{{ like_count }}</span>{% endif %}
                        </a>
                      {% endif %}
                      <a class="d-inline-flex align-items-center gap-1 text-muted" href="{{ url_for('main.view_post', post_id=post.id, open_reply=1) }}" style="text-decoration:none;">
                        <span>ğŸ’¬</span><span>è¿”ä¿¡</span><span>({{ post.replies|length }})</span>
                      </a>
                    </div>
                    <a class="btn btn-sm btn-link text-decoration-none" href="{{ url_for('main.view_post', post_id=post.id) }}">â†— ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’é–‹ã</a>
                  </div>
                </div>
              </div>
            </div>
          {% endfor %}
        {% else %}
          <div class="card p-4">
            <p class="text-muted mb-0">ã¾ã ã‚¹ãƒ¬ãƒƒãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
          </div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Create Post Modal -->
  {% if g.user and (community.id in g.following_ids) %}
  <div class="modal fade" id="createPostModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <form action="{{ url_for('main.create_post') }}" method="post" enctype="multipart/form-data">
          <div class="modal-header">
            <h5 class="modal-title">ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’ä½œæˆ</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label fw-semibold">æŠ•ç¨¿å…ˆ: {{ community.name }}</label>
              <input type="hidden" name="community_id" value="{{ community.id }}">
              <p class="small text-muted">ã“ã®ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã«ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’ä½œæˆã—ã¾ã™</p>
            </div>
            <div class="mb-3">
              <textarea name="body" rows="4" class="input" placeholder="ã‚¹ãƒ¬ãƒƒãƒ‰æœ¬æ–‡ï¼ˆç”»åƒæœ€å¤§4å€‹ã€ã¾ãŸã¯å‹•ç”»1å€‹ã¾ã§ï¼‰"></textarea>
            </div>
            <div class="mb-3">
              <input id="post-file-input" type="file" name="files" accept="image/*,video/*" multiple class="form-control">
            </div>
            <div id="post-media-preview" class="mt-3" style="display:none">
              <h6 class="mb-2">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h6>
              <div id="post-images-preview"></div>
              <div id="post-video-preview"></div>
              <div class="mt-2"><button type="button" id="post-remove-media" class="btn btn-sm btn-outline-danger">æ·»ä»˜ã‚’å‰Šé™¤</button></div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="submit" class="btn btn-primary">æŠ•ç¨¿</button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Image Carousel Modal -->
  <div class="modal fade" id="imageCarouselModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header border-0">
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body text-center p-0">
          <img id="carouselMainImage" src="" alt="image" style="width:100%;max-height:70vh;object-fit:contain">
        </div>
        <div class="modal-footer border-0 justify-content-center">
          <button type="button" id="prevImageBtn" class="btn btn-outline-secondary">â† å‰ã¸</button>
          <span id="imageCounter" class="text-muted mx-2">1 / 1</span>
          <button type="button" id="nextImageBtn" class="btn btn-outline-secondary">æ¬¡ã¸ â†’</button>
        </div>
      </div>
    </div>
  </div>
{% endblock %}
